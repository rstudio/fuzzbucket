name: main
on: [push, pull_request]
env:
  AWS_DEFAULT_REGION: us-east-1
permissions:
  contents: write
jobs:
  default:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python: [3.9.x, 3.10.x]
    steps:
    - uses: actions/checkout@v3
    - run: git fetch --prune --unshallow
    - uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python }}
        architecture: x64
    - uses: actions/setup-node@v3
      with:
        node-version: 18.x
    - uses: extractions/setup-just@v1
    - uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/Pipfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    - uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
        restore-keys: |
          ${{ runner.os }}-node-
    - run: pip install -U pipenv
    - run: just deps
    - run: pipenv check
    - run: just lint
    - run: just test
    - run: just release-artifact
      id: create_release_artifact
    - run: pipenv run pip install -vvv ${{ steps.create_release_artifact.outputs.tarball }}
    - run: pipenv run fuzzbucket-client --version
    - run: pipenv run fuzzbucket-client --help
    - run: just is-releasable
      id: check_releasable
    - if: matrix.python == '3.10.x' && startsWith(github.ref, 'refs/tags') && fromJson(steps.check_releasable.outputs.releasable)
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.create_release_artifact.outputs.tarball }}
    - if: matrix.python == '3.10.x' && startsWith(github.ref, 'refs/tags') && fromJson(steps.check_releasable.outputs.releasable)
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET }}
        aws-region: us-east-1
    - if: matrix.python == '3.10.x' && startsWith(github.ref, 'refs/tags') && fromJson(steps.check_releasable.outputs.releasable)
      run: just sync-to-s3
    - if: matrix.python == '3.10.x' && startsWith(github.ref, 'refs/tags') && fromJson(steps.check_releasable.outputs.releasable)
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_TOKEN }}
